<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bobo Reporter - Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .device-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        #report-container {
            min-height: 400px;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-book"></i> Bobo Reporter
            </span>
            <span class="text-light">Making access to your eReader highlights easy and pretty</span>
        </div>
    </nav>

    <div class="container mt-5">
        <!-- Main Content -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="bi bi-laptop"></i> Device Scanner</h3>
                    </div>
                    <div class="card-body">
                        <!-- Status Alert -->
                        <div id="status-alert" class="alert d-none" role="alert"></div>

                        <!-- Device Selection -->
                        <div class="mb-4">
                            <h5 class="mb-3">Select your device type:</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card device-card h-100" data-device="kobo">
                                        <div class="card-body text-center">
                                            <i class="bi bi-tablet-landscape" style="font-size: 3rem; color: #0d6efd;"></i>
                                            <h5 class="mt-3">Kobo eReader</h5>
                                            <p class="text-muted mb-0">Connect your Kobo device</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card device-card h-100" data-device="kindle">
                                        <div class="card-body text-center">
                                            <i class="bi bi-tablet-landscape" style="font-size: 3rem; color: #ff9900;"></i>
                                            <h5 class="mt-3">Kindle</h5>
                                            <p class="text-muted mb-0">Connect your Kindle device</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scanner Section -->
                        <div id="scanner-section" class="mb-4 d-none">
                            <div class="d-grid gap-2">
                                <button id="scan-btn" class="btn btn-primary btn-lg">
                                    <i class="bi bi-search"></i> Scan for Device
                                </button>
                            </div>
                            <div id="scan-status" class="mt-3 text-center"></div>
                        </div>

                        <!-- File Upload Section -->
                        <div class="mb-4">
                            <h5 class="mb-3">Or upload a file manually:</h5>
                            <div class="upload-area" id="upload-area">
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="mt-3">
                                    <strong>Drag and drop</strong> your file here or 
                                    <label for="file-input" class="text-primary" style="cursor: pointer;">click to browse</label>
                                </p>
                                <input type="file" id="file-input" class="d-none" accept=".txt,.sqlite,.db">
                                <small class="text-muted d-block mt-2">
                                    For Kindle: My Clippings.txt | For Kobo: KoboReader.sqlite
                                </small>
                            </div>
                            <div id="upload-status" class="mt-3"></div>
                        </div>

                        <!-- Report Container -->
                        <div id="report-section" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Generated Report</h5>
                                <button id="new-report-btn" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-arrow-clockwise"></i> New Report
                                </button>
                            </div>
                            <div id="report-container" class="border rounded p-3 bg-light">
                                <iframe id="report-iframe" src="" style="width: 100%; height: 600px; border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" 
            crossorigin="anonymous"></script>
    <script>
        let selectedDevice = null;

        // Device selection
        document.querySelectorAll('.device-card').forEach(card => {
            card.addEventListener('click', function() {
                selectedDevice = this.dataset.device;
                document.querySelectorAll('.device-card').forEach(c => c.classList.remove('border-primary', 'border-3'));
                this.classList.add('border-primary', 'border-3');
                document.getElementById('scanner-section').classList.remove('d-none');
                showAlert('info', `Selected: ${selectedDevice.charAt(0).toUpperCase() + selectedDevice.slice(1)}`);
            });
        });

        // Scan button
        document.getElementById('scan-btn').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scanning...';
            
            const statusDiv = document.getElementById('scan-status');
            statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';

            try {
                const response = await fetch('/api/scan-device');
                const data = await response.json();

                if (data.status === 'success') {
                    if (data.device.toLowerCase() === selectedDevice) {
                        showAlert('success', `${data.device} device detected! Processing...`);
                        await processDevice(data.device, data.path);
                    } else {
                        showAlert('warning', `Detected ${data.device}, but you selected ${selectedDevice}. Please select the correct device.`);
                    }
                } else {
                    showAlert('warning', data.message || 'No device detected. Try using file upload instead.');
                }
            } catch (error) {
                showAlert('danger', 'Error scanning for device: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-search"></i> Scan for Device';
                statusDiv.innerHTML = '';
            }
        });

        // Process device
        async function processDevice(device, path) {
            try {
                showAlert('info', `Processing ${device} device...`);
                const endpoint = device === 'Kobo' ? '/api/process-kobo' : '/api/process-kindle';
                const method = 'POST';
                const body = device === 'Kindle' ? JSON.stringify({ path: path }) : null;
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: device === 'Kindle' ? { 'Content-Type': 'application/json' } : {},
                    body: body
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('success', data.message);
                    displayReport(data.report_url);
                } else {
                    showAlert('danger', data.message || 'Error processing device');
                }
            } catch (error) {
                showAlert('danger', 'Error processing device: ' + error.message);
            }
        }

        // File upload
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');

        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e);
            }
        });

        async function handleFileSelect(e) {
            const file = e.target.files[0] || e.dataTransfer?.files[0];
            if (!file) return;

            if (!selectedDevice) {
                // Try to detect device type from filename
                if (file.name.includes('Clippings') || file.name.endsWith('.txt')) {
                    selectedDevice = 'kindle';
                } else if (file.name.includes('KoboReader') || file.name.endsWith('.sqlite') || file.name.endsWith('.db')) {
                    selectedDevice = 'kobo';
                } else {
                    showAlert('warning', 'Please select a device type first');
                    return;
                }
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('device_type', selectedDevice);

            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = '<div class="alert alert-info">Uploading and processing file...</div>';

            try {
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('success', data.message);
                    displayReport(data.report_url);
                    statusDiv.innerHTML = '';
                } else {
                    showAlert('danger', data.message || 'Error processing file');
                    statusDiv.innerHTML = '';
                }
            } catch (error) {
                showAlert('danger', 'Error uploading file: ' + error.message);
                statusDiv.innerHTML = '';
            }
        }

        // Display report
        function displayReport(reportUrl) {
            document.getElementById('report-section').classList.remove('d-none');
            document.getElementById('report-iframe').src = reportUrl;
            document.getElementById('report-section').scrollIntoView({ behavior: 'smooth' });
        }

        // New report button
        document.getElementById('new-report-btn').addEventListener('click', function() {
            document.getElementById('report-section').classList.add('d-none');
            document.getElementById('report-iframe').src = '';
            document.querySelectorAll('.device-card').forEach(c => c.classList.remove('border-primary', 'border-3'));
            selectedDevice = null;
            document.getElementById('scanner-section').classList.add('d-none');
            fileInput.value = '';
        });

        // Show alert
        function showAlert(type, message) {
            const alertDiv = document.getElementById('status-alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 5000);
        }
    </script>
</body>
</html>

